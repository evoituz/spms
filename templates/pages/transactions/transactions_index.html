{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link type="text/css" rel="stylesheet" href="{% static 'css/jsgrid.min.css' %}"/>
    <link type="text/css" rel="stylesheet" href="{% static 'css/jsgrid-theme.min.css' %}"/>
{% endblock %}

{% block title %}

{% endblock %}

{% block content %}

    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title text-monospace">Транзакции</h3>
                        <div id="transactionGrid" class="text-monospace" style="font-size: 14px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'js/jsgrid.min.js' %}"></script>
    <script>
        $(function () {
            $.ajax({
                url: {% url 'transactions-list' %},
                type: 'GET',
                dataType: 'json',
            }).done(function (response) {
                let clients = {}
                clients[0] = {
                    name: '',
                    id: 0
                }
                for (let i = 0; i < response.length; i++) {
                    if (response[i].client.id) {
                        clients[response[i].client.id] = {
                            name: response[i].client.name,
                            id: response[i].client.id

                        }
                    }
                }
                let transactions = $('#transactionGrid');
                transactions.jsGrid({
                    width: "100%",
                    deleteConfirm: "Вы действительно хотите удалить товар из корзины?",

                    filtering: true,
                    inserting: false,
                    editing: false,
                    sorting: true,
                    autoload: true,

                    controller: {
                        loadData: function (data) {
                            let d = $.Deferred();
                            $.ajax({
                                url: {% url 'transactions-list' %},
                                type: 'GET',
                                dataType: 'json',
                                data: data,
                            }).done(function (response) {
                                let result = $.grep(response, function (item) {
                                    let date = new Date(item.created_dt)
                                    item.created_dt = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}`
                                    return item
                                });
                                d.resolve(result);
                            });
                            return d.promise();
                        },
                    },

                    fields: [
                        {name: "id", type: "hidden", title: "#", width: 30},
                        {
                            name: "client",
                            type: "select",
                            items: clients,
                            textField: 'name',
                            valueField: 'id',
                            title: "Клиент", itemTemplate: function (value, item) {
                                return value.name
                            }
                        },
                        {
                            name: "created_dt", type: "text", title: "Дата", filterTemplate: function () {
                                this.filterControl = $('<input type="date">')
                                return this.filterControl
                            },
                            filterValue: function () {
                                return this.filterControl.val()
                            }
                        },
                        {name: "products", type: "hidden", title: "Товары"},
                        {name: "final_sum", type: "hidden", title: "Сумма заказа", width: 40},
                        {name: "paid", type: "hidden", title: "Оплачено", width: 40},
                        {name: "debt", type: "hidden", title: "Долг", width: 40},
                        {type: 'control', editButton: false, deleteButton: false, width: 35}
                    ]
                });
            })

        })

    </script>

{% endblock %}